#!/bin/bash
#  This script takes 3 parameters.  
# 1 - The name of the detector (ADProsilica, etc.)
# 2 - The version number (R2-0, etc.)
# 3 - The EPICS architecture (linux-x86_64, etc.)
start="$(date +%s)"

echo "Parameter 1 = " $1
echo "Parameter 2 = " $2
echo "Parameter 3 = " $3

find . -name 'auto_settings.sav_*' -exec rm -fv {} \;
find . -name 'auto_settings.savB*' -exec rm -fv {} \;
find . -name 'core.*' -exec rm -fv {} \;
find . -name '*.exe.*' -exec rm -fv {} \;

AREA_DETECTOR=areaDetector-3-2
ASYN=asyn-4-33
AUTOSAVE=autosave-5-9
BUSY=busy-1-7
CALC=calc-3-7
DEVIOCSTATS=iocStats-3-1-15
SEQ=seq-2-2-5
SSCAN=sscan-2-11-1
BASE_TOP=/epics
BASE=base-7-0-1-1
SUPPORT=/epics/synApps/support
DESTINATION=../$1_Prebuilt_$AREA_DETECTOR_$2_$3

mkdir -p $DESTINATION/temp
HOME=$(pwd)

cd $DESTINATION
DESTINATION=$(pwd)
cd $HOME

cd $BASE_TOP
cp --parents -r -n $BASE/bin/$3 $DESTINATION/temp
cp --parents -r -n $BASE/lib/$3 $DESTINATION/temp
cd $SUPPORT
cp --parents -r -n $AREA_DETECTOR/ADCore/db $DESTINATION/temp
cp --parents -r -n $AREA_DETECTOR/ADCore/documentation $DESTINATION/temp
cp --parents -r -n $AREA_DETECTOR/ADCore/ADApp/Db $DESTINATION/temp
cp --parents -r -n $AREA_DETECTOR/ADCore/ADApp/op $DESTINATION/temp
cp --parents -r -n $AREA_DETECTOR/ADCore/iocBoot $DESTINATION/temp
cp --parents -r -n $AREA_DETECTOR/ADViewers/ImageJ $DESTINATION/temp
cp --parents -r -n $AREA_DETECTOR/ADCore/bin/$3 $DESTINATION/temp
cp --parents -r -n $AREA_DETECTOR/ADCore/lib/$3 $DESTINATION/temp
cp --parents -r -n $AREA_DETECTOR/ADSupport/bin/$3 $DESTINATION/temp
cp --parents -r -n $AREA_DETECTOR/ADSupport/lib/$3 $DESTINATION/temp
cp --parents -r -n $ASYN/opi $DESTINATION/temp
cp --parents -r -n $ASYN/db $DESTINATION/temp
cp --parents -r -n $ASYN/bin/$3 $DESTINATION/temp
cp --parents -r -n $ASYN/lib/$3 $DESTINATION/temp
cp --parents -r -n $AUTOSAVE/asApp/ $DESTINATION/temp
cp --parents -r -n $AUTOSAVE/asApp/op $DESTINATION/temp
cp --parents -r -n $AUTOSAVE/bin/$3 $DESTINATION/temp
cp --parents -r -n $AUTOSAVE/lib/$3 $DESTINATION/temp
cp --parents -r -n $BUSY/busyApp/Db $DESTINATION/temp
cp --parents -r -n $BUSY/busyApp/op $DESTINATION/temp
cp --parents -r -n $BUSY/bin/$3 $DESTINATION/temp
cp --parents -r -n $BUSY/lib/$3 $DESTINATION/temp
cp --parents -r -n $CALC/calcApp/Db $DESTINATION/temp
cp --parents -r -n $CALC/calcApp/ $DESTINATION/temp
cp --parents -r -n $CALC/bin/$3 $DESTINATION/temp
cp --parents -r -n $CALC/lib/$3 $DESTINATION/temp
cp --parents -r -n $DEVIOCSTATS/db $DESTINATION/temp
cp --parents -r -n $DEVIOCSTATS/op/adl $DESTINATION/temp
cp --parents -r -n $DEVIOCSTATS/bin/$3 $DESTINATION/temp
cp --parents -r -n $DEVIOCSTATS/lib/$3 $DESTINATION/temp
cp --parents -r -n $SEQ/bin/$3 $DESTINATION/temp
cp --parents -r -n $SEQ/lib/$3 $DESTINATION/temp
cp --parents -r -n $SSCAN/sscanApp/Db $DESTINATION/temp
cp --parents -r -n $SSCAN/sscanApp/op $DESTINATION/temp
cp --parents -r -n $SSCAN/bin/$3 $DESTINATION/temp
cp --parents -r -n $SSCAN/lib/$3 $DESTINATION/temp

PLUGIN=$1
while ! [ "$PLUGIN" = done ]; do    
    cp --parents -r -n $AREA_DETECTOR/$PLUGIN/db $DESTINATION/temp
    cp --parents -r -n $AREA_DETECTOR/$PLUGIN/bin/$3 $DESTINATION/temp
    cp --parents -r -n $AREA_DETECTOR/$PLUGIN/lib/$3 $DESTINATION/temp
    cp --parents -r -n $AREA_DETECTOR/$PLUGIN/documentation $DESTINATION/temp
    cp --parents -r -n $AREA_DETECTOR/$PLUGIN/iocs/*IOC/bin/$3 $DESTINATION/temp
    cp --parents -r -n $AREA_DETECTOR/$PLUGIN/iocs/*IOC/lib/$3 $DESTINATION/temp
    cp --parents -r -n $AREA_DETECTOR/$PLUGIN/iocs/*IOC/dbd $DESTINATION/temp
    cp --parents -r -n $AREA_DETECTOR/$PLUGIN/iocs/*IOC/iocBoot $DESTINATION/temp
    cp --parents -r -n $AREA_DETECTOR/$PLUGIN/*/Db $DESTINATION/temp
    cp --parents -r -n $AREA_DETECTOR/$PLUGIN/*/op $DESTINATION/temp
    echo Enter name of additional detector to add or \"done\" to exit:
    read PLUGIN
done

cd $DESTINATION
echo "Verions used in this deployment: " > README.txt
echo EPICS $BASE >> README.txt
echo $AREA_DETECTOR >> README.txt
echo $ASYN >> README.txt
echo $AUTOSAVE >> README.txt
echo $BUSY >> README.txt
echo $CALC >> README.txt
echo $DEVIOCSTATS >> README.txt
echo $SEQ >> README.txt
echo $SSCAN >> README.txt

cd $HOME

echo tarring...
tar -cjf $1_Prebuilt_$AREA_DETECTOR_$2_$3.tar.gz -C $DESTINATION .
echo done.

mv $1_Prebuilt_$AREA_DETECTOR_$2_$3.tar.gz $DESTINATION
rm -rf $DESTINATION/temp

end="$(date +%s)"
time=$(($end-$start))
echo time: $time seconds
